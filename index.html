<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gambia Teacher Directory ‚Äî Full Demo</title>
<meta name="description" content="Gambia Teacher Directory: Regions, Districts, Schools, Teachers, Nationwide dashboard & statistics" />
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#9aa4b2;
    --gold:#d4af37;
    --silver:#c0c6cc;
    --diamond:#bfe9ff;
    --glass:rgba(255,255,255,0.04);
    --radius:12px;
    --maxw:1400px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:
      radial-gradient(1000px 360px at 8% 8%, rgba(212,175,55,0.06), transparent),
      radial-gradient(900px 280px at 92% 88%, rgba(191,233,255,0.03), transparent),
      var(--bg);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:2rem 1rem;
  }
  .layout{max-width:var(--maxw);margin:0 auto;}
  header{display:flex;align-items:center;gap:1rem;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:1rem;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:.6rem 1rem;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--gold),#ffd27f 40%,var(--diamond));display:grid;place-items:center;color:#08101a;font-weight:800;font-size:20px}
  h1{margin:0;font-size:1.25rem;line-height:1;color:var(--gold)}
  .lead{color:var(--muted);font-size:.95rem}
  .controls{display:flex;gap:.6rem;margin-top:.75rem;align-items:center;flex-wrap:wrap}
  .search{flex:1;display:flex;align-items:center;background:var(--glass);padding:.45rem;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .search input{background:transparent;border:0;color:inherit;padding:.45rem .6rem;outline:none;font-size:0.95rem}
  .btn{background:linear-gradient(90deg,var(--gold),#ffd27f);Color:#08101a;padding:.5rem .9rem;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  main{display:grid;grid-template-columns:320px 1fr;gap:1rem;margin-top:1rem}
  aside{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-height:68vh;overflow:auto}
  .region-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:.5rem}
  .region-item{padding:.6rem;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:1px solid transparent}
  .region-item:hover{background:rgba(255,255,255,0.02)}
  .region-item.active{background:linear-gradient(90deg,rgba(212,175,55,0.06),rgba(191,233,255,0.02));border-color:rgba(212,175,55,0.08)}
  .content{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-height:68vh;overflow:auto}
  .district{background:rgba(255,255,255,0.01);padding:.8rem;border-radius:12px;margin-bottom:1rem;border:1px solid rgba(255,255,255,0.02)}
  .district h3{margin:0;color:var(--gold);font-size:1rem}
  .schools-grid{display:flex;flex-direction:column;gap:.6rem;margin-top:.6rem}
  .school{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:.6rem;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .school h4{margin:0 0 .45rem 0;font-size:0.95rem}
  .section-row{display:flex;gap:.6rem;flex-wrap:wrap}
  .section{flex:1;min-width:220px;background:rgba(255,255,255,0.01);padding:.5rem;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .teacher{display:flex;gap:.6rem;align-items:center;padding:.45rem;border-radius:10px;margin-bottom:.45rem;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
  .avatar-wrap{width:56px;height:56px;border-radius:8px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(180deg,var(--silver),rgba(255,255,255,0.06))}
  .avatar{display:block;width:48px;height:48px;border-radius:8px;object-fit:cover}
  .initials{font-weight:700;color:#08101a}
  .tinfo{flex:1}
  .tinfo b{display:block}
  .tmeta{font-size:.85rem;color:var(--muted);margin-top:.25rem}
  footer{margin-top:1rem;color:var(--muted);font-size:.9rem;text-align:center}
  select{background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:inherit;padding:.5rem;border-radius:10px}
  .dashboard{display:grid;grid-template-columns:1fr 320px;gap:1rem;margin-bottom:1rem}
  .dash-card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .stat-row{display:flex;gap:.6rem;flex-wrap:wrap}
  .stat{flex:1;min-width:160px;background:rgba(255,255,255,0.02);padding:.6rem;border-radius:10px;text-align:center}
  .stat h3{margin:0;color:var(--gold)}
  .region-summary{display:flex;flex-direction:column;gap:.4rem;margin-top:.6rem}
  .region-line{display:flex;justify-content:space-between;align-items:center;padding:.4rem;border-radius:8px;background:rgba(255,255,255,0.01)}
  .tabs{display:flex;gap:.6rem;margin-bottom:.6rem}
  .tab-btn{flex:1;padding:.5rem;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;cursor:pointer}
  .tab-btn.active{background:linear-gradient(90deg,var(--gold),#ffd27f);color:#08101a;font-weight:700}
  .stats-table{width:100%;border-collapse:collapse;margin-top:.6rem}
  .stats-table th,.stats-table td{padding:.6rem;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  .small-muted{color:var(--muted);font-size:.9rem}
  @media (max-width:980px){main{grid-template-columns:1fr} .dashboard{grid-template-columns:1fr} .controls{flex-direction:column;align-items:stretch}}
  /* small staff box styles */
  .staff-box{display:flex;gap:.5rem;align-items:center;padding:.45rem;border-radius:8px;margin-bottom:.45rem;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
  .staff-role{min-width:86px;font-weight:700}
  .staff-meta{font-size:.85rem;color:var(--muted)}
</style>
</head>
<body>
  <div class="layout">
    <header>
      <div class="brand">
        <div class="logo">GM</div>
        <div>
          <h1>Gambia Teacher Directory</h1>
          <div class="lead">Regions ‚Üí Districts ‚Üí Schools ‚Üí Teachers ‚Äî (by Lamin Ceesay)</div>
        </div>
      </div>
      <div style="display:flex;gap:.6rem;align-items:center">
        <button class="btn" id="viewStatsTop">View Statistics</button>
        <button class="btn">Admin</button>
      </div>
    </header>

    <div class="controls">
      <div class="search"><svg width="18" height="18" viewBox="0 0 24 24" style="opacity:.85;margin-right:.4rem"><path d="M21 21l-4.35-4.35" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11.5" cy="11.5" r="5.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><input id="searchInput" placeholder="Search teachers, schools, districts, regions" /></div>
      <select id="regionFilter"><option value="">All Regions</option></select>
      <select id="districtFilter"><option value="">All Districts</option></select>
      <select id="schoolFilter"><option value="">All Schools</option></select>
      <button class="btn" id="clearBtn">Clear</button>
    </div>

    <main>
      <aside>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
          <h4 style="color:var(--gold);margin:0">Regions</h4>
          <div class="small-muted">Toggle</div>
        </div>
        <div class="tabs" style="margin-bottom:.6rem">
          <button class="tab-btn active" id="tabRegions">Regions</button>
          <button class="tab-btn" id="tabStats">Statistics</button>
        </div>
        <ul class="region-list" id="regionList"></ul>
      </aside>

      <section class="content" id="contentArea">
        <!-- Dashboard (top) + Region list injected here -->
      </section>
    </main>

    <footer>editing in progress ‚Äî data autogenerated for demo purposes.</footer>
  </div>

<script>
/*
  (ORIGINAL SCRIPT - unchanged)
  ... your entire existing code as pasted ...
  [Note: for brevity in this message we assume your original script is present here exactly as pasted]
*/
</script>

<!-- ===== EXTENSION SCRIPT (adds cooks, caretakers, securities + updated stats) ===== -->
<script>
/*
  Extension summary:
  - Augment each school with: cooks (1), caretakers (1), securities (2)
  - Extend computeTotals to include non-teaching staff and region-level non-teaching counts
  - Update dashboard to display non-teaching totals
  - Add staff list under each school card (visible when viewing region or filtered results)
  - Extend Statistics table and CSV export to include new columns
  - Ensure search includes staff names as well
*/

/* ----------------------------------------------------------
   Safety: reference-checks ‚Äî your original objects must exist
   ---------------------------------------------------------- */
if(typeof fullData === 'undefined'){
  console.error('Extension aborted: fullData not found.');
} else {
  // 1) small staff name pools (rotating)
  const staffMale = [
    'Modou Colley','Musa Bojang','Jatta Kinteh','Omar Faal','Saidu Jobe','Baba Drammeh'
  ];
  const staffFemale = [
    'Fatoumata Sanyang','Isatou Njie','Awa Bah','Kadiatu Faal','Saffie Ceesay','Hannah Darboe'
  ];

  // helper to create staff person
  function makeStaff(role, index, schoolIndex, useFemale){
    const name = useFemale
      ? staffFemale[(schoolIndex + index) % staffFemale.length]
      : staffMale[(schoolIndex + index) % staffMale.length];
    const initials = name.split(' ').map(n=>n[0]).slice(0,2).join('');
    const photo = `https://via.placeholder.com/120/ffffff/08101a?text=${encodeURIComponent(initials)}`;
    return {
      name,
      initials,
      role,
      gender: useFemale ? 'Female' : 'Male',
      tin: genID('TIN'),
      idNo: genID('GMBID'),
      photo
    };
  }

  // 2) Attach staff arrays to each school in fullData (1 cook, 1 caretaker, 2 securities)
  fullData.forEach((r, rIdx) => {
    r.districts.forEach((d, dIdx) => {
      d.schools.forEach((s, sIdx) => {
        // keep existing teachers intact
        // add a staff array with objects: role is one of Cook, Caretaker, Security
        const cooks = [ makeStaff('Cook', 0, sIdx, true) ]; // female by default
        const caretakers = [ makeStaff('Caretaker', 0, sIdx, false) ];
        const securities = [
          makeStaff('Security', 0, sIdx, false),
          makeStaff('Security', 1, sIdx, true)
        ];
        // attach categorized and combined
        s.nonTeaching = {
          cooks,
          caretakers,
          securities,
          list: [...cooks, ...caretakers, ...securities]
        };
      });
    });
  });

  // 3) preserve original computeTotals and replace with enhanced version
  const originalComputeTotals = (typeof computeTotals === 'function') ? computeTotals : null;

  function enhancedComputeTotals(dataset = fullData){
    // start from original totals (teachers only) if available
    const base = originalComputeTotals ? originalComputeTotals(dataset) : {
      nationwide: { total:0, male:0, female:0, byLevel:{Primary:0,Junior:0,Senior:0} },
      regions: []
    };

    // Now compute non-teaching totals
    const totals = JSON.parse(JSON.stringify(base)); // shallow clone of numbers
    totals.nationwide.nonTeaching = { cooks:0, caretakers:0, securities:0, total:0 };
    totals.regions = []; // recompute per-region including non-teaching

    dataset.forEach(r => {
      const rEntry = { region: r.region, total:0, male:0, female:0, byLevel: { Primary:0, Junior:0, Senior:0 }, nonTeaching: { cooks:0, caretakers:0, securities:0, total:0 } };

      r.districts.forEach(d => {
        d.schools.forEach(s => {
          const sTeacherCount = s.teachers ? s.teachers.length : 0;
          rEntry.total += sTeacherCount;
          // byLevel
          if(rEntry.byLevel[s.level] !== undefined){
            rEntry.byLevel[s.level] += sTeacherCount;
          }
          // male/female teachers
          if(s.teachers && s.teachers.length){
            s.teachers.forEach(t => {
              if(t.gender === 'Male'){ rEntry.male++; }
              else { rEntry.female++; }
            });
          }

          // non-teaching counts for this school
          if(s.nonTeaching){
            const cooks = (s.nonTeaching.cooks || []).length;
            const caretakers = (s.nonTeaching.caretakers || []).length;
            const securities = (s.nonTeaching.securities || []).length;
            rEntry.nonTeaching.cooks += cooks;
            rEntry.nonTeaching.caretakers += caretakers;
            rEntry.nonTeaching.securities += securities;
            rEntry.nonTeaching.total += (cooks + caretakers + securities);

            totals.nationwide.nonTeaching.cooks += cooks;
            totals.nationwide.nonTeaching.caretakers += caretakers;
            totals.nationwide.nonTeaching.securities += securities;
            totals.nationwide.nonTeaching.total += (cooks + caretakers + securities);
          }
        });
      });

      totals.regions.push(rEntry);
    });

    // ensure nationwide totals keep teacher counts from base (already present)
    // and attach nonTeaching totals
    return totals;
  }

  // override global computeTotals
  computeTotals = enhancedComputeTotals;

  // 4) Enhance renderDashboard by calling original and then inserting non-teaching stats
  const originalRenderDashboard = (typeof renderDashboard === 'function') ? renderDashboard : null;
  function enhancedRenderDashboard(totals){
    // call original to render main structure
    if(originalRenderDashboard) originalRenderDashboard(totals);
    // Now append non-teaching block under nationSummaryInner
    const ns = document.getElementById('nationSummaryInner');
    if(ns){
      const nonHtml = document.createElement('div');
      nonHtml.style.marginTop = '0.8rem';
      nonHtml.innerHTML = `
        <strong class="small-muted">Non-Teaching Staff (Nationwide)</strong>
        <div style="display:flex;gap:.6rem;margin-top:.4rem;flex-wrap:wrap">
          <div class="stat" style="min-width:120px">
            <h3>${totals.nationwide.nonTeaching.cooks.toLocaleString()}</h3>
            <div class="small-muted">Cooks</div>
          </div>
          <div class="stat" style="min-width:120px">
            <h3>${totals.nationwide.nonTeaching.caretakers.toLocaleString()}</h3>
            <div class="small-muted">Caretakers</div>
          </div>
          <div class="stat" style="min-width:120px">
            <h3>${totals.nationwide.nonTeaching.securities.toLocaleString()}</h3>
            <div class="small-muted">Securities</div>
          </div>
          <div class="stat" style="min-width:120px">
            <h3>${totals.nationwide.nonTeaching.total.toLocaleString()}</h3>
            <div class="small-muted">Total Non-Teaching</div>
          </div>
        </div>
      `;
      ns.appendChild(nonHtml);
    }

    // Also, update regions overview lines to show non-teaching counts if present
    const roi = document.getElementById('regionsOverviewInner');
    if(roi){
      // clear and re-add with non-teaching if available
      roi.innerHTML = '';
      totals.regions.forEach(r => {
        const line = document.createElement('div');
        line.className = 'region-line';
        const non = r.nonTeaching ? ` ‚Ä¢ NT: ${r.nonTeaching.total}` : '';
        line.innerHTML = `<div style="font-weight:700">${r.region}</div><div class="small-muted">${r.total} teachers${non}</div>`;
        roi.appendChild(line);
      });
    }
  }
  renderDashboard = enhancedRenderDashboard;

  // 5) After a region is rendered by original renderRegion, append staff info to each school card
  const originalRenderRegion = (typeof renderRegion === 'function') ? renderRegion : null;
  function enhancedRenderRegion(regionObj){
    if(!originalRenderRegion) return;
    originalRenderRegion(regionObj);

    // now find each .school element and append staff info using the regionObj (which references fullData)
    // build a map of schoolName -> nonTeaching list
    const schoolMap = {};
    regionObj.districts.forEach(d => {
      d.schools.forEach(s => {
        schoolMap[s.name] = s.nonTeaching || {list:[]};
      });
    });

    // find all school nodes currently in the DOM
    const schoolEls = Array.from(document.querySelectorAll('.content .school'));
    schoolEls.forEach(el => {
      // get school title to match
      const h4 = el.querySelector('h4');
      if(!h4) return;
      const title = h4.firstChild ? h4.firstChild.textContent.trim() : h4.textContent.trim();
      const sData = schoolMap[title];
      if(!sData) return;

      // create staff section
      const staffSection = document.createElement('div');
      staffSection.className = 'section';
      staffSection.style.marginTop = '8px';
      staffSection.innerHTML = `<small>Non-Teaching Staff</small>`;

      // for each staff person add a condensed card
      (sData.list || []).forEach(st => {
        const stEl = document.createElement('div');
        stEl.className = 'staff-box';
        stEl.innerHTML = `
          <div class="avatar-wrap" style="width:48px;height:48px;border-radius:8px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(180deg,var(--silver),rgba(255,255,255,0.06))">
            <img class="avatar" src="${st.photo}" alt="${st.initials}" style="width:40px;height:40px;border-radius:6px;object-fit:cover" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'initials\\'>${st.initials}</div>'" />
          </div>
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">${st.name}</div>
              <div style="font-size:.82rem;color:var(--muted)">${st.gender}</div>
            </div>
            <div class="staff-meta">${st.role} ‚Ä¢ TIN: ${st.tin} ‚Ä¢ ID: ${st.idNo}</div>
          </div>
        `;
        staffSection.appendChild(stEl);
      });

      // append under the teachers section (find existing .section)
      const lastSection = el.querySelector('.section-row .section:last-child');
      if(lastSection && lastSection.parentNode){
        // place the staffSection next to teachers ‚Äî or below it if space constrained
        lastSection.parentNode.appendChild(staffSection);
      } else {
        el.appendChild(staffSection);
      }
    });
  }
  renderRegion = enhancedRenderRegion;

  // 6) Replace renderStatisticsView with an enhanced version that includes non-teaching columns and updated CSV
  const originalRenderStatisticsView = (typeof renderStatisticsView === 'function') ? renderStatisticsView : null;
  function enhancedRenderStatisticsView(){
    // compute totals using enhanced computeTotals
    const totals = computeTotals(fullData);

    // build new table with non-teaching columns
    contentArea.innerHTML = '';
    const statsCard = document.createElement('div');
    statsCard.className = 'dash-card';
    statsCard.innerHTML = `
      <h2 style="color:var(--gold);margin:0 0 .4rem 0">Statistics Report</h2>
      <div class="small-muted">Detailed region / level breakdown (includes non-teaching staff)</div>
      <div id="statsTableWrap"></div>
    `;
    contentArea.appendChild(statsCard);

    const wrap = document.getElementById('statsTableWrap');

    let html = `
      <table class="stats-table">
        <thead>
          <tr>
            <th>Region</th>
            <th>Primary</th>
            <th>Junior</th>
            <th>Senior</th>
            <th>Teachers</th>
            <th>Male</th>
            <th>Female</th>
            <th>Cooks</th>
            <th>Caretakers</th>
            <th>Securities</th>
            <th>Non-Teaching</th>
          </tr>
        </thead>
        <tbody>
    `;

    totals.regions.forEach(r => {
      const nt = r.nonTeaching || {cooks:0, caretakers:0, securities:0, total:0};
      html += `<tr>
        <td style="width:30%">${r.region}</td>
        <td>${r.byLevel.Primary}</td>
        <td>${r.byLevel.Junior}</td>
        <td>${r.byLevel.Senior}</td>
        <td>${r.total}</td>
        <td>${r.male}</td>
        <td>${r.female}</td>
        <td>${nt.cooks}</td>
        <td>${nt.caretakers}</td>
        <td>${nt.securities}</td>
        <td>${nt.total}</td>
      </tr>`;
    });

    html += `</tbody>
      <tfoot>
        <tr style="font-weight:700">
          <td>Total (Nationwide)</td>
          <td>${totals.nationwide.byLevel.Primary}</td>
          <td>${totals.nationwide.byLevel.Junior}</td>
          <td>${totals.nationwide.byLevel.Senior}</td>
          <td>${totals.nationwide.total}</td>
          <td>${totals.nationwide.male}</td>
          <td>${totals.nationwide.female}</td>
          <td>${totals.nationwide.nonTeaching.cooks}</td>
          <td>${totals.nationwide.nonTeaching.caretakers}</td>
          <td>${totals.nationwide.nonTeaching.securities}</td>
          <td>${totals.nationwide.nonTeaching.total}</td>
        </tr>
      </tfoot>
      </table>
    `;
    wrap.innerHTML = html;

    // CSV export (extended)
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn';
    exportBtn.style.marginTop = '10px';
    exportBtn.textContent = 'Export CSV';
    wrap.appendChild(exportBtn);

    exportBtn.addEventListener('click', () => {
      let csv = 'Region,Primary,Junior,Senior,Teachers,Male,Female,Cooks,Caretakers,Securities,NonTeaching\n';
      totals.regions.forEach(r => {
        const nt = r.nonTeaching || {cooks:0, caretakers:0, securities:0, total:0};
        csv += `"${r.region}",${r.byLevel.Primary},${r.byLevel.Junior},${r.byLevel.Senior},${r.total},${r.male},${r.female},${nt.cooks},${nt.caretakers},${nt.securities},${nt.total}\n`;
      });
      csv += `Nationwide,${totals.nationwide.byLevel.Primary},${totals.nationwide.byLevel.Junior},${totals.nationwide.byLevel.Senior},${totals.nationwide.total},${totals.nationwide.male},${totals.nationwide.female},${totals.nationwide.nonTeaching.cooks},${totals.nationwide.nonTeaching.caretakers},${totals.nationwide.nonTeaching.securities},${totals.nationwide.nonTeaching.total}\n`;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gambia_teacher_statistics_extended.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }
  renderStatisticsView = enhancedRenderStatisticsView;

  // 7) Update filterAndRender so searches also match staff names (teachers + nonTeaching)
  const originalFilterAndRender = (typeof filterAndRender === 'function') ? filterAndRender : null;
  function enhancedFilterAndRender(){
    const q = (searchInput.value || '').trim().toLowerCase();
    const regionVal = regionFilter.value;
    const districtVal = districtFilter.value;
    const schoolVal = schoolFilter.value;

    const filtered = fullData
      .filter(r => !regionVal || r.region === regionVal)
      .map(r => {
        const districts = r.districts
          .filter(d => !districtVal || d.district === districtVal)
          .map(d => {
            const schools = d.schools
              .filter(s => !schoolVal || s.name === schoolVal)
              .map(s => {
                const teachers = (s.teachers || []).filter(t =>
                  !q ||
                  t.name.toLowerCase().includes(q) ||
                  s.name.toLowerCase().includes(q) ||
                  d.district.toLowerCase().includes(q) ||
                  r.region.toLowerCase().includes(q)
                );

                // staff match (cooks/caretakers/securities)
                const staffMatch = (s.nonTeaching && s.nonTeaching.list) ? s.nonTeaching.list.filter(st =>
                  !q || st.name.toLowerCase().includes(q)
                ) : [];

                // if query exists and teachers didn't match but staff did, keep those staff
                // We'll create a combined view where teachers that match remain; staff that match are shown separately.
                // To keep UI consistent, we'll include the school if either teachers or staffMatch or the general school/district/region matched.
                const keepSchool = (!q) || teachers.length > 0 || staffMatch.length > 0 || s.name.toLowerCase().includes(q) || d.district.toLowerCase().includes(q) || r.region.toLowerCase().includes(q);

                // Build resulting school object but with filtered teachers (and attach filtered staff list)
                return { ...s, teachers, nonTeaching: { ...s.nonTeaching, filteredList: staffMatch } , keepSchool };
              })
              .filter(s => s.keepSchool);
            return {...d, schools};
          })
          .filter(d => d.schools.length > 0);
        return {...r, districts};
      })
      .filter(r => r.districts.length > 0);

    // Render filtered results ‚Äî similar to original logic but include staff
    contentArea.innerHTML = '';
    if(filtered.length === 0){
      contentArea.innerHTML = `<div style="color:var(--muted)">No results found.</div>`;
      return;
    }

    const totals = computeTotals(filtered);
    renderDashboard(totals);

    filtered.forEach(r => {
      const regionTitle = document.createElement('h2');
      regionTitle.style.color = 'var(--gold)';
      regionTitle.style.marginTop = '0';
      regionTitle.textContent = r.region;
      contentArea.appendChild(regionTitle);

      r.districts.forEach(d => {
        const dEl = document.createElement('div');
        dEl.className = 'district';
        dEl.innerHTML = `<h3>üìç ${d.district}</h3>`;
        const grid = document.createElement('div');
        grid.className = 'schools-grid';

        d.schools.forEach(s => {
          const male = (s.teachers || []).filter(t => t.gender === 'Male').length;
          const female = (s.teachers || []).filter(t => t.gender === 'Female').length;
          const sEl = document.createElement('div');
          sEl.className = 'school';
          sEl.innerHTML = `<h4>${s.name} <small style="color:var(--muted)">(${s.level})</small></h4>
            <div class="small-muted" style="margin-bottom:.6rem">Total Teachers: <strong>${(s.teachers || []).length}</strong> (${male} M ‚Ä¢ ${female} F)</div>
          `;
          const secRow = document.createElement('div');
          secRow.className = 'section-row';
          const section = document.createElement('div');
          section.className = 'section';
          section.innerHTML = `<small>Teachers</small>`;

          (s.teachers || []).forEach(t => {
            const tEl = document.createElement('div');
            tEl.className = 'teacher';
            tEl.innerHTML = `
              <div class="avatar-wrap"><img class="avatar" src="${t.photo}" alt="${t.initials}" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'initials\\'>${t.initials}</div>'" /></div>
              <div class="tinfo">
                <b>${t.name}</b>
                <div class="tmeta">${t.gender} ‚Ä¢ ${t.shift} shift ‚Ä¢ ${t.experience} yrs</div>
                <div class="tmeta">TIN: ${t.tin} ‚Ä¢ ID: ${t.idNo}</div>
              </div>
            `;
            section.appendChild(tEl);
          });

          secRow.appendChild(section);

          // staff area (use filteredList if exists else entire list)
          const staffSection = document.createElement('div');
          staffSection.className = 'section';
          staffSection.innerHTML = `<small>Non-Teaching Staff</small>`;
          const staffList = (s.nonTeaching && (s.nonTeaching.filteredList && s.nonTeaching.filteredList.length) ? s.nonTeaching.filteredList : (s.nonTeaching ? s.nonTeaching.list : []));

          (staffList || []).forEach(st => {
            const stEl = document.createElement('div');
            stEl.className = 'staff-box';
            stEl.innerHTML = `
              <div class="avatar-wrap" style="width:48px;height:48px;border-radius:8px;overflow:hidden;display:grid;place-items:center;background:linear-gradient(180deg,var(--silver),rgba(255,255,255,0.06))">
                <img class="avatar" src="${st.photo}" alt="${st.initials}" style="width:40px;height:40px;border-radius:6px;object-fit:cover" onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\\'initials\\'>${st.initials}</div>'" />
              </div>
              <div style="flex:1">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div style="font-weight:700">${st.name}</div>
                  <div style="font-size:.82rem;color:var(--muted)">${st.gender}</div>
                </div>
                <div class="staff-meta">${st.role} ‚Ä¢ TIN: ${st.tin} ‚Ä¢ ID: ${st.idNo}</div>
              </div>
            `;
            staffSection.appendChild(stEl);
          });

          secRow.appendChild(staffSection);
          sEl.appendChild(secRow);
          grid.appendChild(sEl);
        });

        dEl.appendChild(grid);
        contentArea.appendChild(dEl);
      });
    });
  }

  filterAndRender = enhancedFilterAndRender;

  // 8) Ensure tabs still point to the enhanced functions
  // re-bind tab clicks if they were set earlier ‚Äî safe to attach again
  try{
    document.getElementById('tabRegions').addEventListener('click', () => {
      document.getElementById('tabRegions').classList.add('active');
      document.getElementById('tabStats').classList.remove('active');
      // show regions (renderRegionsView from original should call new renderDashboard)
      if(typeof renderRegionsView === 'function') renderRegionsView();
    });
    document.getElementById('tabStats').addEventListener('click', () => {
      document.getElementById('tabRegions').classList.remove('active');
      document.getElementById('tabStats').classList.add('active');
      if(typeof renderStatisticsView === 'function') renderStatisticsView();
    });
    // back to stats top button
    document.getElementById('viewStatsTop').addEventListener('click', () => {
      document.getElementById('tabStats').click();
      document.getElementById('contentArea').scrollIntoView({behavior:'smooth', block:'start'});
    });
  } catch(e){ /* ignore */ }

  // 9) initial refresh: if Regions view is currently active, re-render to show staff
  if(document.getElementById('tabRegions') && document.getElementById('tabRegions').classList.contains('active')){
    if(typeof renderRegionsView === 'function'){
      renderRegionsView();
      // re-run a quick filter/render to populate lists (original page called both on load)
      filterAndRender();
    }
  } else {
    // else ensure the statistics view also renders correctly if active
    if(document.getElementById('tabStats') && document.getElementById('tabStats').classList.contains('active')){
      renderStatisticsView();
    }
  }

  console.log('Extension loaded: non-teaching staff added and stats enhanced.');
}
</script>
</body>
</html>