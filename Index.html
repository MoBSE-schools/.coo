<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>National School Staff Dashboard — Full</title>
  <meta name="description" content="National School Staff Dashboard — Teachers, Cooks, Caretakers, Secretaries. Admin CRUD and local persistence.">
  <style>
    /* ---------- Theme & Reset ---------- */
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #0753e6;
      --accent: #07b6b3;
      --shadow: 0 8px 30px rgba(15,23,42,0.06);
      --glass: rgba(255,255,255,0.75);
      --danger:#ef4444;
      --success:#10b981;
      --radius:12px;
    }
    *{box-sizing:border-box;font-family: Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);color:#0f172a}
    a{color:var(--primary);text-decoration:none}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--primary);color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;box-shadow:var(--shadow);font-weight:600}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(7,83,230,0.12);box-shadow:none}
    .btn.warn{background:var(--danger)}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .panel{height:72vh;overflow:auto}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .stat{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;text-align:center}
    .stat h3{margin:0;font-size:18px}
    .stat p{margin:6px 0 0;color:var(--muted);font-size:13px}

    /* tables */
    table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f1f5f9}
    thead th{background:linear-gradient(90deg,#fbfbff,#f7fafc);position:sticky;top:0}
    tbody tr:nth-child(even){background:#fbfdff}
    .muted{color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f7ff;color:var(--primary);font-weight:600;font-size:12px}

    /* sidebar admin */
    aside .admin{display:flex;flex-direction:column;gap:10px}
    input,select{padding:8px;border-radius:8px;border:1px solid #e6eef8}
    .row{display:flex;gap:8px}
    .right{display:flex;gap:8px;align-items:center}

    /* modals */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-card{width:560px;background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
    .modal-row{display:flex;gap:8px;margin-bottom:8px}
    .modal h3{margin:0 0 10px}

    /* responsive */
    @media (max-width:980px){.grid{grid-template-columns:1fr}.panel{height:60vh}.stat-grid{grid-template-columns:repeat(2,1fr)}.modal-card{width:95%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>National School Staff Dashboard</h1>
        <div class="small">Teachers · Cooks · Caretakers · Secretaries — male/female counts & totals</div>
      </div>

      <div class="controls">
        <button class="btn" id="adminBtn">Admin</button>
        <button class="btn ghost" id="resetData">Reset Sample</button>
        <button class="btn ghost" id="exportBtn">Export JSON</button>
        <label for="importFile" class="btn ghost" style="cursor:pointer;margin:0">Import JSON</label>
        <input type="file" id="importFile" accept=".json" style="display:none" />
      </div>
    </header>

    <div class="grid">
      <main>
        <div class="card panel" id="mainPanel">
          <div class="section-title">
            <strong>Overview</strong>
            <div class="small">Live totals — update when you edit staff</div>
          </div>

          <div class="stat-grid" id="overviewStats"></div>

          <div style="margin-top:8px;margin-bottom:12px">
            <label class="small">Filter by region</label>
            <select id="regionFilter" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid #e6eef8"></select>
          </div>

          <div id="regionsContainer"></div>
        </div>
      </main>

      <aside>
        <div class="card">
          <div class="section-title"><strong>Admin Panel</strong><span class="small muted"> (protected) </span></div>
          <div class="admin">
            <div class="small muted">Logged in as: <strong id="adminUser">-</strong></div>
            <div class="row">
              <button class="btn" id="addRegionBtn">+ Add Region</button>
              <button class="btn ghost" id="addDistrictBtn">+ Add District</button>
            </div>
            <div class="row">
              <button class="btn ghost" id="addSchoolBtn">+ Add School</button>
              <button class="btn ghost" id="clearStorageBtn">Clear All Data</button>
            </div>

            <div style="height:8px"></div>
            <div class="small muted">Admin credentials: <strong>admin</strong> / <strong>1234</strong></div>
            <div style="height:8px"></div>
            <div class="row">
              <button class="btn ghost" id="loginLogoutBtn">Login</button>
              <button class="btn ghost warn" id="logoutBtn" style="display:none">Logout</button>
            </div>

            <hr />
            <div class="small">
              Tips:
              <ul>
                <li>Click region/district/school <em>Edit</em> to change names.</li>
                <li>Click a school's <em>Edit Staff</em> to change male/female counts.</li>
                <li>Use Export/Import to backup or move data.</li>
              </ul>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="card small muted">
          <strong>About</strong>
          <p style="margin:8px 0 0">This page stores data in your browser's <code>localStorage</code>. Use Import/Export to move data between devices.</p>
        </div>
      </aside>
    </div>
  </div>

  <!-- ====== Modals ====== -->
  <div id="loginModal" class="modal" style="display:none">
    <div class="modal-card">
      <h3>Admin Login</h3>
      <div class="modal-row">
        <input id="loginUser" placeholder="username" style="flex:1" value="admin" />
      </div>
      <div class="modal-row">
        <input id="loginPass" type="password" placeholder="password" style="flex:1" value="1234"/>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn ghost" id="cancelLogin">Cancel</button>
        <button class="btn" id="doLogin">Login</button>
      </div>
    </div>
  </div>

  <div id="editStaffModal" class="modal" style="display:none">
    <div class="modal-card" id="editStaffCard">
      <h3>Edit Staff — <span id="editSchoolTitle"></span></h3>
      <div class="small muted" id="editSchoolPath"></div>
      <form id="staffForm">
        <div style="margin-top:12px">
          <!-- categories form injected here -->
        </div>
        <div style="height:12px"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button type="button" class="btn ghost" id="cancelEditStaff">Cancel</button>
          <button type="submit" class="btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editNameModal" class="modal" style="display:none">
    <div class="modal-card">
      <h3 id="editNameTitle">Edit</h3>
      <div style="margin-top:8px"><input id="editNameInput" style="width:100%" /></div>
      <div style="height:8px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn ghost" id="cancelEditName">Cancel</button>
        <button class="btn" id="saveEditName">Save</button>
      </div>
    </div>
  </div>

  <div id="addEntityModal" class="modal" style="display:none">
    <div class="modal-card">
      <h3 id="addEntityTitle">Add</h3>
      <div style="margin-top:8px" id="addEntityBody">
        <!-- form injected -->
      </div>
      <div style="height:10px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn ghost" id="cancelAddEntity">Cancel</button>
        <button class="btn" id="saveAddEntity">Add</button>
      </div>
    </div>
  </div>

  <!-- ====== Templates (not visible) ====== -->
  <template id="schoolCardTemplate">
    <div class="card school-card" style="margin-bottom:10px">
      <div class="section-title">
        <strong class="schoolTitle"></strong>
        <div>
          <button class="btn ghost editSchoolBtn">Edit</button>
          <button class="btn ghost editStaffBtn">Edit Staff</button>
          <button class="btn ghost deleteSchoolBtn">Delete</button>
        </div>
      </div>
      <div class="small muted schoolMeta"></div>
      <table class="staffTable" style="margin-top:8px">
        <thead><tr><th>Category</th><th>Male</th><th>Female</th><th>Total</th></tr></thead>
        <tbody class="staffBody"></tbody>
      </table>
    </div>
  </template>

  <script>
  /* ========= Data model & persistence ========= */
  const STORAGE_KEY = 'full_school_staff_v1';

  // default categories we will show in the unified table
  const CATEGORIES = ['Teachers','Cooks','Caretakers','Secretaries'];

  // sample data generator for quick full demo (The Gambia-like regions)
  function generateFullSample(){
    const regionNames = [
      'Banjul',
      'Kanifing Municipality',
      'West Coast Region',
      'Lower River Region',
      'Central River Region',
      'Upper River Region',
      'North Bank Region'
    ];
    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    const data = { regions: [] };
    regionNames.forEach((rname,ri)=>{
      const region = { id:'r'+ri, name:rname, districts: [] };
      const numDistricts = rand(2,4);
      for(let d=0; d<numDistricts; d++){
        const district = { id: region.id+'d'+d, name: `${rname} District ${d+1}`, schools: [] };
        const numSchools = rand(3,6);
        for(let s=0; s<numSchools; s++){
          const school = {
            id: district.id+'s'+s,
            name: `School ${s+1}`,
            type: ['Primary','Junior','Senior'][rand(0,2)],
            staff: {}
          };
          CATEGORIES.forEach(cat=>{
            // realistic ranges: teachers 5-20, cooks 0-4, caretakers 0-3, secretaries 0-2
            let male=0,female=0;
            if(cat==='Teachers'){ male=rand(0,12); female=rand(2,12); }
            else if(cat==='Cooks'){ male=rand(0,2); female=rand(0,4); }
            else if(cat==='Caretakers'){ male=rand(0,2); female=rand(0,1); }
            else if(cat==='Secretaries'){ male=rand(0,1); female=rand(0,2); }
            school.staff[cat] = { male, female };
          });
          district.schools.push(school);
        }
        region.districts.push(district);
      }
      data.regions.push(region);
    });
    return data;
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{ return JSON.parse(raw); } catch(e){ console.warn('Invalid JSON in storage, resetting.'); }
    }
    const sample = generateFullSample();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(sample));
    return sample;
  }
  let STATE = loadState();

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
    renderAll();
  }

  function resetSample(){
    if(!confirm('Reset to new sample data? This will overwrite current local data.')) return;
    STATE = generateFullSample();
    saveState();
    alert('Sample reset.');
  }

  function clearAllData(){
    if(!confirm('Clear ALL local data? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    STATE = generateFullSample();
    saveState();
    alert('Cleared. New sample loaded.');
  }

  /* ========= Aggregation helpers ========= */
  function schoolTotals(school){
    const totals = {}; let schoolTotal = 0;
    CATEGORIES.forEach(cat=>{
      const male = (school.staff[cat]?.male)||0;
      const female = (school.staff[cat]?.female)||0;
      const tot = male + female;
      totals[cat] = {male,female,total: tot};
      schoolTotal += tot;
    });
    return { totals, total: schoolTotal };
  }

  function districtTotals(district){
    const totals = {}; CATEGORIES.forEach(c=>totals[c]=0);
    let districtTotal = 0;
    district.schools.forEach(s=>{
      CATEGORIES.forEach(c=>{
        const male = (s.staff[c]?.male)||0; const female = (s.staff[c]?.female)||0;
        totals[c] += male + female;
        districtTotal += male + female;
      });
    });
    return { totals, total: districtTotal };
  }

  function regionTotals(region){
    const totals = {}; CATEGORIES.forEach(c=>totals[c]=0);
    let regionTotal = 0;
    region.districts.forEach(d=>{
      d.schools.forEach(s=>{
        CATEGORIES.forEach(c=>{
          totals[c] += ((s.staff[c]?.male)||0) + ((s.staff[c]?.female)||0);
          regionTotal += ((s.staff[c]?.male)||0) + ((s.staff[c]?.female)||0);
        });
      });
    });
    return { totals, total: regionTotal };
  }

  function nationalTotals(){
    const totals = {}; CATEGORIES.forEach(c=>totals[c]=0);
    let natTotal = 0;
    STATE.regions.forEach(r=>{
      r.districts.forEach(d=>{
        d.schools.forEach(s=>{
          CATEGORIES.forEach(c=>{
            const male = (s.staff[c]?.male)||0; const female = (s.staff[c]?.female)||0;
            totals[c] += male + female; natTotal += male + female;
          });
        });
      });
    });
    return { totals, total: natTotal };
  }

  /* ========= Render UI ========= */
  const regionFilter = document.getElementById('regionFilter');
  const overviewStats = document.getElementById('overviewStats');
  const regionsContainer = document.getElementById('regionsContainer');

  function renderAll(){
    renderRegionFilter();
    renderOverview();
    renderRegions();
    updateAdminUser();
  }

  function renderRegionFilter(){
    const opts = ['<option value="all">All Regions</option>'];
    STATE.regions.forEach(r=> opts.push(`<option value="${r.id}">${r.name}</option>`));
    regionFilter.innerHTML = opts.join('');
  }

  function renderOverview(){
    const nat = nationalTotals();
    const html = CATEGORIES.map(cat=>{
      return `<div class="stat"><h3>${nat.totals[cat]||0}</h3><p>${cat}</p></div>`;
    }).join('') + `<div class="stat" style="grid-column:span 3"><h3>${nat.total}</h3><p>All staff (national total)</p></div>`;
    overviewStats.innerHTML = html;
  }

  function renderRegions(){
    const selected = regionFilter.value || 'all';
    let html = '';
    const regionsToShow = selected === 'all' ? STATE.regions : STATE.regions.filter(r=>r.id===selected);
    regionsToShow.forEach(region=>{
      const rTotals = regionTotals(region);
      html += `<div class="card" style="margin-bottom:14px"><div class="section-title"><strong style="font-size:16px">${region.name}</strong><div class="small muted">Region total: ${rTotals.total} staff</div></div>`;
      region.districts.forEach(district=>{
        const dTotals = districtTotals(district);
        html += `<div class="card" style="margin-bottom:10px;padding:12px"><div class="section-title"><strong>${district.name}</strong><div class="small muted">District total: ${dTotals.total} | Schools: ${district.schools.length}</div></div>`;
        // each school
        district.schools.forEach(school=>{
          const s = schoolTotals(school);
          html += `<div class="card" style="margin-bottom:8px;padding:10px">
            <div class="section-title">
              <strong>${school.name} — ${school.type}</strong>
              <div>
                <button class="btn ghost editSchoolNameBtn" data-school="${school.id}" data-region="${region.id}" data-district="${district.id}">Edit</button>
                <button class="btn ghost editSchoolStaffBtn" data-school="${school.id}" data-region="${region.id}" data-district="${district.id}">Edit Staff</button>
                <button class="btn ghost deleteSchoolBtn" data-school="${school.id}" data-region="${region.id}" data-district="${district.id}">Delete</button>
              </div>
            </div>
            <div class="small muted">Total: ${s.total} staff</div>
            <table style="margin-top:8px">
              <thead><tr><th>Category</th><th>Male</th><th>Female</th><th>Total</th></tr></thead>
              <tbody>`;
          CATEGORIES.forEach(cat=>{
            const male = (school.staff[cat]?.male)||0;
            const female = (school.staff[cat]?.female)||0;
            html += `<tr><td>${cat}</td><td>${male}</td><td>${female}</td><td>${male+female}</td></tr>`;
          });
          html += `</tbody></table></div>`;
        }); // school loop

        html += `</div>`; // district card
      }); // district loop

      html += `</div>`; // region card
    });

    regionsContainer.innerHTML = html;
  }

  /* ========= Event wiring & admin actions ========= */

  // region filter change
  regionFilter.addEventListener('change', renderAll);

  // export
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const data = JSON.stringify(STATE, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'school_staff_data.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // import
  document.getElementById('importFile').addEventListener('change', (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const parsed = JSON.parse(r.result);
        if(!parsed.regions) throw new Error('Invalid format');
        if(confirm('Import will replace current data. Continue?')){
          STATE = parsed;
          saveState();
          alert('Import successful');
        }
      }catch(err){ alert('Invalid JSON file or format.'); }
    };
    r.readAsText(f);
  });

  // reset sample
  document.getElementById('resetData').addEventListener('click', resetSample);
  document.getElementById('clearStorageBtn').addEventListener('click', clearAllData);

  // admin login / logout
  function updateAdminUser(){
    const adminUser = sessionStorage.getItem('adminUser') || '-';
    document.getElementById('adminUser').textContent = adminUser;
    const loggedIn = !!sessionStorage.getItem('adminUser');
    document.getElementById('loginLogoutBtn').textContent = loggedIn ? 'Logged in' : 'Login';
    document.getElementById('logoutBtn').style.display = loggedIn ? 'inline-flex' : 'none';
  }

  document.getElementById('adminBtn').addEventListener('click', ()=> {
    if(sessionStorage.getItem('adminUser')){ alert('Already logged in as '+sessionStorage.getItem('adminUser')); updateAdminUser(); return; }
    document.getElementById('loginModal').style.display = 'flex';
  });

  document.getElementById('doLogin').addEventListener('click', ()=>{
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    if(u==='admin' && p==='1234'){
      sessionStorage.setItem('adminUser', u);
      document.getElementById('loginModal').style.display = 'none';
      updateAdminUser();
      alert('Login successful');
    } else { alert('Invalid credentials'); }
  });
  document.getElementById('cancelLogin').addEventListener('click', ()=>{ document.getElementById('loginModal').style.display='none'; });

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    sessionStorage.removeItem('adminUser'); updateAdminUser(); alert('Logged out'); 
  });

  // small login button in sidebar
  document.getElementById('loginLogoutBtn').addEventListener('click', ()=>{
    if(sessionStorage.getItem('adminUser')) { alert('Already logged in as '+sessionStorage.getItem('adminUser')); return; }
    document.getElementById('loginModal').style.display = 'flex';
  });

  // Add region/district/school modals
  document.getElementById('addRegionBtn').addEventListener('click', ()=>{
    if(!sessionStorage.getItem('adminUser')) return alert('Please login as admin first');
    openAddEntityModal('region');
  });
  document.getElementById('addDistrictBtn').addEventListener('click', ()=>{
    if(!sessionStorage.getItem('adminUser')) return alert('Please login as admin first');
    openAddEntityModal('district');
  });
  document.getElementById('addSchoolBtn').addEventListener('click', ()=>{
    if(!sessionStorage.getItem('adminUser')) return alert('Please login as admin first');
    openAddEntityModal('school');
  });

  function openAddEntityModal(kind, prefill={}){
    // kind: 'region' | 'district' | 'school'
    const modal = document.getElementById('addEntityModal');
    const title = document.getElementById('addEntityTitle');
    const body = document.getElementById('addEntityBody');
    title.textContent = `Add ${kind.charAt(0).toUpperCase()+kind.slice(1)}`;
    body.innerHTML = '';

    if(kind==='region'){
      body.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><input id="newRegionName" placeholder="Region name" value="${prefill.name||''}" /><input id="newRegionCode" placeholder="Region code (optional)" value="${prefill.code||''}" /></div>`;
    } else if(kind==='district'){
      // need to choose region
      const regionOptions = STATE.regions.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
      body.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
        <label class="small">Choose region</label>
        <select id="newDistrictRegion">${regionOptions}</select>
        <input id="newDistrictName" placeholder="District name" value="${prefill.name||''}" />
      </div>`;
    } else if(kind==='school'){
      const regionOptions = STATE.regions.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
      body.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px">
        <label class="small">Choose region</label>
        <select id="newSchoolRegion">${regionOptions}</select>
        <label class="small">Choose district</label>
        <select id="newSchoolDistrict"></select>
        <input id="newSchoolName" placeholder="School name" value="${prefill.name||''}" />
        <select id="newSchoolType"><option>Primary</option><option>Junior</option><option>Senior</option></select>
        <div class="small muted">Initial staff counts (optional) — leave blank to set zeros.</div>
        <div id="newSchoolStaffInputs"></div>
      </div>`;
      // populate districts after DOM places selects:
      setTimeout(()=> {
        populateDistrictsForSelect(document.getElementById('newSchoolRegion'), document.getElementById('newSchoolDistrict'));
        // inject inputs for categories
        const staffInputs = document.getElementById('newSchoolStaffInputs');
        CATEGORIES.forEach(cat=>{
          const idMale = 'ns_' + cat + '_m'; const idFem='ns_' + cat + '_f';
          staffInputs.insertAdjacentHTML('beforeend', `<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <div style="width:140px">${cat}</div>
            <input id="${idMale}" placeholder="male" style="width:80px" />
            <input id="${idFem}" placeholder="female" style="width:80px" />
          </div>`);
        });
      }, 30);
    }

    modal.style.display = 'flex';

    // Save handler
    const saveBtn = document.getElementById('saveAddEntity');
    const cancelBtn = document.getElementById('cancelAddEntity');
    const onSave = ()=>{
      if(kind==='region'){
        const name = document.getElementById('newRegionName').value.trim();
        if(!name){ alert('Region name required'); return; }
        STATE.regions.push({ id:'r'+Date.now(), name, districts: [] });
        saveState(); modal.style.display='none'; cleanup();
      } else if(kind==='district'){
        const regionId = document.getElementById('newDistrictRegion').value;
        const name = document.getElementById('newDistrictName').value.trim();
        if(!name){ alert('District name required'); return; }
        const region = STATE.regions.find(r=>r.id===regionId);
        if(!region){ alert('Region not found'); return; }
        region.districts.push({ id: region.id+'d'+Date.now(), name, schools: [] });
        saveState(); modal.style.display='none'; cleanup();
      } else if(kind==='school'){
        const regionId = document.getElementById('newSchoolRegion').value;
        const districtId = document.getElementById('newSchoolDistrict').value;
        const name = document.getElementById('newSchoolName').value.trim();
        const type = document.getElementById('newSchoolType').value;
        if(!regionId || !districtId || !name){ alert('Please choose region, district and provide a name.'); return; }
        const region = STATE.regions.find(r=>r.id===regionId);
        if(!region) return alert('Region missing');
        const district = region.districts.find(d=>d.id===districtId);
        if(!district) return alert('District missing');
        const staff = {};
        CATEGORIES.forEach(cat=>{
          const mVal = document.getElementById('ns_'+cat+'_m')?.value || '';
          const fVal = document.getElementById('ns_'+cat+'_f')?.value || '';
          staff[cat] = { male: parseInt(mVal)||0, female: parseInt(fVal)||0 };
        });
        district.schools.push({ id: district.id+'s'+Date.now(), name, type, staff });
        saveState(); modal.style.display='none'; cleanup();
      }
    };
    saveBtn.onclick = onSave;
    cancelBtn.onclick = ()=>{ modal.style.display='none'; cleanup(); };

    function cleanup(){ saveBtn.onclick = null; cancelBtn.onclick = null; }
  }

  function populateDistrictsForSelect(regionSelectEl, districtSelectEl){
    districtSelectEl.innerHTML = '';
    const regionId = regionSelectEl.value;
    const region = STATE.regions.find(r=>r.id===regionId);
    if(region){
      districtSelectEl.innerHTML = region.districts.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
    } else districtSelectEl.innerHTML = '<option value="">-- no districts --</option>';
    // update on region change
    regionSelectEl.onchange = ()=>populateDistrictsForSelect(regionSelectEl, districtSelectEl);
  }

  // delegate clicks for Edit/Delete on rendered school cards
  document.getElementById('regionsContainer').addEventListener('click', (e)=>{
    const el = e.target;
    if(el.matches('.editSchoolNameBtn')){
      if(!sessionStorage.getItem('adminUser')) return alert('Please login as admin first');
      const schoolId = el.dataset.school; const regionId = el.dataset.region; const districtId = el.dataset.district;
      openEditNameModal('school', regionId, districtId, schoolId);
    } else if(el.matches('.editSchoolStaffBtn')){
      if(!sessionStorage.getItem('adminUser')) return alert('Please login as admin first');
      const schoolId = el.dataset.school; const regionId = el.dataset.region; const districtId = el.dataset.district;
      openEditStaffModal(regionId, districtId, schoolId);
    } else if(el.matches('.deleteSchoolBtn')){
      if(!sessionStorage.getItem('adminUser')) return alert('Please login as admin first');
      const schoolId = el.dataset.school; const regionId = el.dataset.region; const districtId = el.dataset.district;
      if(confirm('Delete this school? This cannot be undone.')){
        const region = STATE.regions.find(r=>r.id===regionId);
        const district = region.districts.find(d=>d.id===districtId);
        district.schools = district.schools.filter(s=>s.id!==schoolId);
        saveState();
      }
    }
  });

  // Edit name modal (for region/district/school)
  function openEditNameModal(kind, regionId, districtId, schoolId){
    const modal = document.getElementById('editNameModal');
    const title = document.getElementById('editNameTitle');
    const input = document.getElementById('editNameInput');
    let current = '';

    if(kind==='region'){
      const r = STATE.regions.find(rr=>rr.id===regionId); if(!r) return alert('Region not found');
      title.textContent = `Edit Region`;
      input.value = r.name; current = r.name;
    } else if(kind==='district'){
      const r = STATE.regions.find(rr=>rr.id===regionId); if(!r) return alert('Region not found');
      const d = r.districts.find(dd=>dd.id===districtId); if(!d) return alert('District not found');
      title.textContent = 'Edit District'; input.value = d.name; current = d.name;
    } else {
      const r = STATE.regions.find(rr=>rr.id===regionId); if(!r) return alert('Region not found');
      const d = r.districts.find(dd=>dd.id===districtId); if(!d) return alert('District not found');
      const s = d.schools.find(ss=>ss.id===schoolId); if(!s) return alert('School not found');
      title.textContent = 'Edit School'; input.value = s.name; current = s.name;
    }

    modal.style.display = 'flex';

    const saveBtn = document.getElementById('saveEditName');
    const cancelBtn = document.getElementById('cancelEditName');

    const onSave = ()=>{
      const val = input.value.trim();
      if(!val){ alert('Name required'); return; }
      if(kind==='region'){ const r = STATE.regions.find(rr=>rr.id===regionId); r.name = val; }
      else if(kind==='district'){ const r = STATE.regions.find(rr=>rr.id===regionId); const d = r.districts.find(dd=>dd.id===districtId); d.name = val; }
      else { const r = STATE.regions.find(rr=>rr.id===regionId); const d = r.districts.find(dd=>dd.id===districtId); const s = d.schools.find(ss=>ss.id===schoolId); s.name = val; }
      saveState(); modal.style.display='none'; cleanup();
    };
    saveBtn.onclick = onSave;
    cancelBtn.onclick = ()=>{ modal.style.display='none'; cleanup(); };

    function cleanup(){ saveBtn.onclick=null; cancelBtn.onclick=null; }
  }

  // Edit staff modal
  function openEditStaffModal(regionId, districtId, schoolId){
    const modal = document.getElementById('editStaffModal');
    const title = document.getElementById('editSchoolTitle');
    const path = document.getElementById('editSchoolPath');
    const form = document.getElementById('staffForm');

    const region = STATE.regions.find(r=>r.id===regionId); if(!region) return alert('Region not found');
    const district = region.districts.find(d=>d.id===districtId); if(!district) return alert('District not found');
    const school = district.schools.find(s=>s.id===schoolId); if(!school) return alert('School not found');

    title.textContent = school.name;
    path.textContent = `${region.name} → ${district.name} → ${school.type}`;

    // build form fields
    const container = form.querySelector('div');
    container.innerHTML = '';
    CATEGORIES.forEach(cat=>{
      const maleVal = (school.staff[cat]?.male) || 0;
      const femaleVal = (school.staff[cat]?.female) || 0;
      const idMale = 'edit_'+cat+'_m';
      const idFemale = 'edit_'+cat+'_f';
      container.insertAdjacentHTML('beforeend', `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
        <div style="width:140px">${cat}</div>
        <input id="${idMale}" type="number" min="0" style="width:120px" value="${maleVal}" />
        <input id="${idFemale}" type="number" min="0" style="width:120px" value="${femaleVal}" />
      </div>`);
    });

    modal.style.display = 'flex';

    // handlers
    const cancelBtn = document.getElementById('cancelEditStaff');
    cancelBtn.onclick = ()=>{ modal.style.display='none'; cancelBtn.onclick=null; form.onsubmit=null; };

    form.onsubmit = (ev)=>{
      ev.preventDefault();
      // save into STATE
      CATEGORIES.forEach(cat=>{
        const male = parseInt(document.getElementById('edit_'+cat+'_m').value) || 0;
        const female = parseInt(document.getElementById('edit_'+cat+'_f').value) || 0;
        school.staff[cat] = { male, female };
      });
      saveState();
      modal.style.display='none';
      cancelBtn.onclick=null; form.onsubmit=null;
      alert('Staff updated');
    };
  }

  // initial render
  renderAll();

  // small convenience: delegate double-click on region/district cards to edit names (if admin)
  document.getElementById('regionsContainer').addEventListener('dblclick', (e)=>{
    if(!sessionStorage.getItem('adminUser')) return;
    // try to detect which name was clicked by walking up to closest card and reading its strong text
    let el = e.target;
    while(el && !el.classList.contains('card')) el = el.parentElement;
    if(!el) return;
    const strong = el.querySelector('.section-title strong');
    if(!strong) return;
    const text = strong.textContent || '';
    // attempt to find matching region/district/school
    // regions
    const region = STATE.regions.find(r=>r.name===text);
    if(region){ openEditNameModal('region', region.id); return; }
    // districts & schools search
    for(const r of STATE.regions){
      const d = r.districts.find(dd=>dd.name===text);
      if(d){ openEditNameModal('district', r.id, d.id); return; }
      for(const s of d?.schools||[]){
        if(s && s.name===text){ openEditNameModal('school', r.id, d.id, s.id); return; }
      }
    }
  });

  // small helper: add keyboard escape to close modals
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    }
  });

  </script>
</body>
</html>